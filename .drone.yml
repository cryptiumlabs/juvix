---
kind: pipeline
type: docker
name: juvix-ci-build-pr

workspace:
  path: /drone/workspace

environment:
  STACK_ROOT: /drone/workspace/.stack

steps:
  - name: script-integrity-check
    image: alpine:3.7 
    pull: if-not-exists
    commands:
      # - echo "bbd7240242839ed5051ba48ebb3b2e66a4cdeb50945ff96e09c0869dc219ceef  scripts/run-formatter.sh" | sha256sum -c -
      # - echo "a2cb891077e670ccf9546df3ad1e7629e9e8858680a281bc836abfcef414641a  scripts/run-org-generation.sh" | sha256sum -c -
      - echo "4438c2dfcd3aa0e4a3700fb5865c9b8e9bd208c38b1cb52b91b5393f56571a03  scripts/check-formatting.sh" | sha256sum -c -
      - echo "13f9fae7f558567336505324e4c54dabe978ba7441617854dd31d9f9e9c85c60  scripts/check-org-gen.sh" | sha256sum -c -
      - echo $${DRONE_COMMIT_SHA}
      - git show -s --format=%B $${DRONE_COMMIT_SHA}

  - name: restore-cache
    image: meltwater/drone-cache
    pull: if-not-exists
    settings:
      backend: "s3"
      restore: true
      bucket: juvix-drone-cache
      region: eu-west-1
      cache_key: "{{ checksum \"stack.yaml\" }}"
      archive_format: "gzip"
      mount:
        - ./.stack-work
        - ./.stack
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    volumes:
      - name: cache
        path: /tmp/cache
    depends_on:
      - script-integrity-check

  - name: test-suite
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    commands:
      - make test
    depends_on:
      - restore-cache

  - name: rebuild-cache
    image: meltwater/drone-cache
    pull: if-not-exists
    volumes:
      - name: cache
        path: /tmp/cache
    settings:
      backend: "s3"
      bucket: juvix-drone-cache
      region: eu-west-1
      rebuild: true
      archive_format: "gzip"
      override: false
      cache_key: "{{ checksum \"stack.yaml\" }}"
      mount:
        - ./.stack-work
        - ./.stack
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    when:
      status:
        - success
        - failure
    depends_on:
      - test-suite

  - name: test-parser
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - make test-parser
    depends_on:
      - test-suite

  - name: test-typecheck
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - make test-typecheck
    depends_on:
      - test-suite

  - name: test-compile
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - make test-compile
    depends_on:
      - test-suite
  
  - name: org-generation-and-code-formatting
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - sh ./scripts/format_and_org_gen.sh   
    depends_on:
      - test-typecheck
      - test-compile
      - test-parser

  - name: Push changes
    image: appleboy/drone-git-push
    settings:
      branch: $${$DRONE_SOURCE_BRANCH}
      remote: "git@github.com:heliaxdev/juvix.git"
      force: false
      commit: true
      commit_message: "[skip ci] format and org generation" 
      author_name: Drone CI
      author_email: gianmarco@heliax.dev
    depends_on:
      - org-generation-and-code-formatting

volumes:
  - name: cache
    host: 
      path: /tmp/cache

trigger:
  event:
    - pull_request
---
kind: pipeline
type: docker
name: juvix-ci-build-push-develop

workspace:
  path: /drone/workspace

environment:
  STACK_ROOT: /drone/workspace/.stack

steps:
  - name: script-integrity-check
    image: alpine:3.7
    pull: if-not-exists
    commands:
      # - echo "bbd7240242839ed5051ba48ebb3b2e66a4cdeb50945ff96e09c0869dc219ceef  scripts/run-formatter.sh" | sha256sum -c -
      # - echo "a2cb891077e670ccf9546df3ad1e7629e9e8858680a281bc836abfcef414641a  scripts/run-org-generation.sh" | sha256sum -c -
      - echo "4438c2dfcd3aa0e4a3700fb5865c9b8e9bd208c38b1cb52b91b5393f56571a03  scripts/check-formatting.sh" | sha256sum -c -
      - echo "13f9fae7f558567336505324e4c54dabe978ba7441617854dd31d9f9e9c85c60  scripts/check-org-gen.sh" | sha256sum -c -

  - name: restore-cache
    image: meltwater/drone-cache
    pull: if-not-exists
    settings:
      backend: "s3"
      restore: true
      bucket: juvix-drone-cache
      region: eu-west-1
      cache_key: "{{ checksum \"stack.yaml\" }}-{{ checksum \"package.yaml\" }}"
      archive_format: "gzip"
      mount:
        - ./.stack-work
        - ./.stack
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    volumes:
      - name: cache
        path: /tmp/cache
    depends_on:
      - script-integrity-check

  - name: test-suite
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    commands:
      - make test
    depends_on:
      - restore-cache

  - name: rebuild-cache
    image: meltwater/drone-cache
    pull: if-not-exists
    volumes:
      - name: cache
        path: /tmp/cache
    settings:
      backend: "s3"
      bucket: juvix-drone-cache
      region: eu-west-1
      rebuild: true
      archive_format: "gzip"
      override: false
      cache_key: "{{ checksum \"stack.yaml\" }}-{{ checksum \"package.yaml\" }}"
      mount:
        - ./.stack-work
        - ./.stack
    environment:
      AWS_ACCESS_KEY_ID:
        from_secret: aws_access_key_id
      AWS_SECRET_ACCESS_KEY:
        from_secret: aws_secret_access_key
    when:
      status:
        - success
        - failure
    depends_on:
      - test-suite

  - name: check-formatting
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - sh ./scripts/check-formatting.sh
    depends_on:
      - test-suite

  - name: check-org-gen
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - sh ./scripts/check-org-gen.sh
    depends_on:
      - test-suite

  - name: test-parser
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - make test-parser
    depends_on:
      - test-suite

  - name: test-typecheck
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - make test-typecheck
    depends_on:
      - test-suite

  - name: test-compile
    image: 922271945067.dkr.ecr.eu-west-1.amazonaws.com/juvix
    pull: if-not-exists
    failure: fast
    commands:
      - make test-compile
    depends_on:
      - test-suite

volumes:
  - name: cache
    host: 
      path: /tmp/cache

trigger:
  event:
    - push
  branch:
    - develop
---
kind: signature
hmac: dfbff981e18e8ccb343acc67562e0a6f7915030ac0f21a454cdabc86b3f47f0a

...
